{% from 'bootstrap5/form.html' import render_field %}
{% extends "base.html" %}
{% block title %}Registrar nuevo paciente{% endblock %}

{% block content %}
<style>
  .form-box {
    border: 1px solid #d3d3d3;
    border-radius: 8px;
    padding: 24px;
    background-color: #fff;
    margin-top: 20px;
  }

  .form-title {
    font-weight: 700;
    font-size: 1.25rem;
    color: #2a2f65;
    margin-bottom: 20px;
  }

  .form-control {
    font-size: 0.95rem;
  }

  .btn-primary {
    background-color: #2a2f65;
    border-color: #2a2f65;
  }

  .btn-primary:hover {
    background-color: #454c9b;
    border-color: #454c9b;
  }

  .submit-row {
    display: flex;
    justify-content: flex-end;
    margin-top: 20px;
    gap: 10px;
  }

  .mic-btn i {
    pointer-events: none;
  }
</style>

<div class="container">
  <div class="form-box">
    <div class="form-title">Datos personales del nuevo paciente</div>
    <form class="row g-3" action="/registrar" method="post">
      {{ form.csrf_token }}
      {% for field in form %}
        {% if field.widget.input_type != 'hidden' and field.type != 'SubmitField' %}
          <div class="col-md-6">
            <label for="{{ field.id }}">{{ field.label.text }}</label>
            <div class="input-group">
              {{ field(class="form-control", id=field.id) }}
              <button type="button" class="btn btn-outline-secondary mic-btn" data-target="{{ field.id }}">
                <i class="bi bi-mic-fill"></i>
              </button>
            </div>
          </div>
        {% endif %}
      {% endfor %}
      <div class="col-12 submit-row">
        <input type="submit" class="btn btn-primary" value="Registrar" />
        <a class="btn btn-secondary" href="/">Volver</a>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const micButtons = document.querySelectorAll(".mic-btn");

    micButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const inputId = btn.getAttribute("data-target");
        const input = document.getElementById(inputId);

        if (!('webkitSpeechRecognition' in window)) {
          alert("Tu navegador no soporta reconocimiento de voz.");
          return;
        }

        const recognition = new webkitSpeechRecognition();
        recognition.lang = "es-ES";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        // Indicar que estÃ¡ escuchando
        btn.classList.remove("btn-outline-secondary");
        btn.classList.add("btn-primary");

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          input.value = transcript;
        };

        recognition.onerror = (event) => {
          console.error("Error de reconocimiento:", event.error);
        };

        recognition.onend = () => {
          btn.classList.remove("btn-primary");
          btn.classList.add("btn-outline-secondary");
        };

        recognition.start();
      });
    });
  });
</script>

{% endblock %}
